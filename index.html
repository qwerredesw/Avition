<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Avition Marketplace</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    
    <style>
        :root { --primary-color: #2ecc71; --bg-color: #f8f9fa; }
        body { background-color: var(--bg-color); font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
        .navbar { background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .product-card { border: none; border-radius: 12px; transition: transform 0.2s; background: white; overflow: hidden; box-shadow: 0 2px 5px rgba(0,0,0,0.02); cursor: pointer;}
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .product-img { height: 200px; object-fit: cover; width: 100%; }
        .fab-btn { position: fixed; bottom: 30px; right: 30px; width: 60px; height: 60px; border-radius: 50%; font-size: 24px; box-shadow: 0 4px 15px rgba(46, 204, 113, 0.4); z-index: 1000; }
        .chat-window { height: 300px; overflow-y: auto; background: #f1f2f6; border-radius: 8px; padding: 10px; margin-bottom: 10px; }
        .message { padding: 8px 12px; border-radius: 15px; margin-bottom: 8px; max-width: 80%; font-size: 0.9rem; }
        .msg-me { background: var(--primary-color); color: white; align-self: flex-end; margin-left: auto; }
        .msg-other { background: white; align-self: flex-start; }
        #loadingOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.9); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container">
            <a class="navbar-brand fw-bold text-success" href="#" onclick="window.location.reload()">Avition</a>
            <div class="d-flex align-items-center">
                <div id="authSection">
                    <button class="btn btn-outline-success btn-sm" data-bs-toggle="modal" data-bs-target="#authModal">Вход / Регистрация</button>
                </div>
                <div id="userSection" class="hidden d-flex align-items-center gap-3">
                    <span id="userName" class="fw-bold small"></span>
                    <button class="btn btn-sm btn-light text-danger" onclick="app.logout()"><i class="bi bi-box-arrow-right"></i></button>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mt-4 mb-5">
        
        <div id="feedView">
            <h4 class="mb-4 fw-light">Лента объявлений</h4>
            <div class="row g-4" id="productsGrid"></div>
        </div>

        <div id="createView" class="hidden">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card shadow-sm border-0 p-4">
                        <h4 class="mb-3">Новое объявление</h4>
                        <form onsubmit="app.createProduct(event)">
                            <div class="mb-3"><label>Название</label><input type="text" class="form-control" id="prodTitle" required></div>
                            <div class="mb-3"><label>Цена (₽)</label><input type="number" class="form-control" id="prodPrice" required></div>
                            <div class="mb-3"><label>Описание</label><textarea class="form-control" id="prodDesc" rows="3" required></textarea></div>
                            <div class="mb-3"><label>Фото</label><input type="file" class="form-control" id="prodImg" accept="image/*" required></div>
                            <div class="d-grid gap-2">
                                <button type="submit" class="btn btn-success">Опубликовать</button>
                                <button type="button" class="btn btn-light" onclick="app.showFeed()">Отмена</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <div id="detailView" class="hidden">
            <button class="btn btn-link text-decoration-none text-muted mb-3" onclick="app.showFeed()">← Назад</button>
            <div class="row">
                <div class="col-md-6 mb-4">
                    <img id="detailImg" src="" class="img-fluid rounded-3 shadow-sm w-100 object-fit-cover" style="max-height: 500px;">
                </div>
                <div class="col-md-6">
                    <h2 id="detailTitle" class="fw-bold"></h2>
                    <h3 class="text-success mb-3" id="detailPrice"></h3>
                    <p class="text-muted" id="detailDesc"></p>
                    <hr>
                    <div class="card bg-light border-0">
                        <div class="card-body">
                            <h6 class="card-title">Продавец: <span id="detailSeller"></span></h6>
                            <div id="chatSection" class="hidden">
                                <div id="chatBox" class="chat-window d-flex flex-column"></div>
                                <div class="input-group">
                                    <input type="text" id="msgInput" class="form-control" placeholder="Сообщение...">
                                    <button class="btn btn-success" onclick="app.sendMessage()"><i class="bi bi-send"></i></button>
                                </div>
                            </div>
                            <div id="loginToChat" class="text-center py-3 hidden"><small>Войдите, чтобы написать</small></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <button id="fabBtn" class="btn btn-success fab-btn hidden" onclick="app.showCreate()"><i class="bi bi-plus-lg"></i></button>
    <div id="loadingOverlay" class="hidden"><div class="spinner-border text-success" role="status"></div></div>

    <div class="modal fade" id="authModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header border-0"><h5 class="modal-title">Вход в Avition</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <ul class="nav nav-pills nav-fill mb-3"><li class="nav-item"><button class="nav-link active" data-bs-toggle="pill" data-bs-target="#loginTab">Вход</button></li><li class="nav-item"><button class="nav-link" data-bs-toggle="pill" data-bs-target="#regTab">Регистрация</button></li></ul>
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="loginTab">
                            <form onsubmit="app.handleLogin(event)">
                                <div class="mb-3"><input type="email" class="form-control" id="loginEmail" placeholder="Email" required></div>
                                <div class="mb-3"><input type="password" class="form-control" id="loginPass" placeholder="Пароль" required></div>
                                <button type="submit" class="btn btn-success w-100">Войти</button>
                            </form>
                        </div>
                        <div class="tab-pane fade" id="regTab">
                            <form onsubmit="app.handleRegister(event)">
                                <div class="mb-3"><input type="text" class="form-control" id="regName" placeholder="Ваше имя" required></div>
                                <div class="mb-3"><input type="email" class="form-control" id="regEmail" placeholder="Email" required></div>
                                <div class="mb-3"><input type="password" class="form-control" id="regPass" placeholder="Пароль (мин. 6 симв.)" required minlength="6"></div>
                                <div class="mb-3"><input type="password" class="form-control" id="regPassConfirm" placeholder="Повторите пароль" required minlength="6"></div>
                                <button type="submit" class="btn btn-success w-100">Зарегистрироваться</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        // ==========================================
        // КЛЮЧИ (ВЕРНЫЕ)
        // ==========================================
        const firebaseConfig = {
            apiKey: "AIzaSyDvV4-QJZPc2RyODuOQpg44hvUcspD_XqE",
            authDomain: "super-market-2025.firebaseapp.com",
            projectId: "super-market-2025",
            storageBucket: "super-market-2025.firebasestorage.app",
            messagingSenderId: "757873908830",
            appId: "1:757873908830:web:dedfaf2b85e3c02029a8cf"
        };
        // ==========================================

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const app = {
            currentUser: null,
            currentProduct: null,
            unsubscribeChat: null,

            init: function() {
                // МЫ УБРАЛИ ТУТ СТРОКУ new bootstrap.Modal, чтобы не было ошибок!
                auth.onAuthStateChanged(user => {
                    this.currentUser = user;
                    this.updateUI();
                    if(!user) this.showFeed();
                });
                this.showFeed();
            },

            updateUI: function() {
                if (this.currentUser) {
                    document.getElementById('authSection').classList.add('hidden');
                    document.getElementById('userSection').classList.remove('hidden');
                    document.getElementById('userName').innerText = this.currentUser.displayName || this.currentUser.email;
                    document.getElementById('fabBtn').classList.remove('hidden');
                } else {
                    document.getElementById('authSection').classList.remove('hidden');
                    document.getElementById('userSection').classList.add('hidden');
                    document.getElementById('fabBtn').classList.add('hidden');
                }
            },

            // ВСПОМОГАТЕЛЬНАЯ ФУНКЦИЯ ДЛЯ ЗАКРЫТИЯ ОКНА
            closeModal: function() {
                try {
                    const modalEl = document.getElementById('authModal');
                    const modal = bootstrap.Modal.getInstance(modalEl); // Берем уже открытое окно
                    if (modal) {
                        modal.hide();
                    } else {
                        // Если JS "потерял" окно, закроем его вручную, убрав класс
                        modalEl.classList.remove('show');
                        modalEl.style.display = 'none';
                        document.body.classList.remove('modal-open');
                        const backdrop = document.querySelector('.modal-backdrop');
                        if(backdrop) backdrop.remove();
                    }
                } catch (e) { console.error(e); }
            },

            // --- Авторизация ---
            handleLogin: async function(e) {
                e.preventDefault();
                try {
                    await auth.signInWithEmailAndPassword(document.getElementById('loginEmail').value, document.getElementById('loginPass').value);
                    this.closeModal(); 
                    e.target.reset();
                } catch (err) { alert("Ошибка входа: " + err.message); }
            },

            handleRegister: async function(e) {
                e.preventDefault();
                const pass1 = document.getElementById('regPass').value;
                const pass2 = document.getElementById('regPassConfirm').value;
                if (pass1 !== pass2) { alert("Пароли не совпадают!"); return; }

                try {
                    const cred = await auth.createUserWithEmailAndPassword(document.getElementById('regEmail').value, pass1);
                    await cred.user.updateProfile({ displayName: document.getElementById('regName').value });
                    this.closeModal(); 
                    e.target.reset(); 
                    window.location.reload();
                } catch (err) { alert("Ошибка регистрации: " + err.message); }
            },
            logout: () => auth.signOut(),

            // --- Логика ---
            showFeed: function() { this.hideViews(); document.getElementById('feedView').classList.remove('hidden'); this.loadFeed(); },
            showCreate: function() { this.hideViews(); document.getElementById('createView').classList.remove('hidden'); },
            hideViews: function() { ['feedView', 'createView', 'detailView'].forEach(id => document.getElementById(id).classList.add('hidden')); },
            toggleLoader: function(s) { document.getElementById('loadingOverlay').classList.toggle('hidden', !s); },

            createProduct: async function(e) {
                e.preventDefault();
                if (!this.currentUser) return;
                this.toggleLoader(true);
                try {
                    const file = document.getElementById('prodImg').files[0];
                    if (!file) throw new Error("Выберите фото!");
                    const imageUrl = await this.compressImage(file); 
                    await db.collection('products').add({
                        title: document.getElementById('prodTitle').value,
                        price: Number(document.getElementById('prodPrice').value),
                        description: document.getElementById('prodDesc').value,
                        imageUrl: imageUrl, 
                        sellerId: this.currentUser.uid,
                        sellerName: this.currentUser.displayName || "Продавец",
                        createdAt: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    e.target.reset(); this.showFeed();
                } catch (err) { alert("Ошибка публикации: " + err.message); } 
                finally { this.toggleLoader(false); }
            },

            compressImage: function(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = (event) => {
                        const img = new Image();
                        img.src = event.target.result;
                        img.onload = () => {
                            const canvas = document.createElement('canvas');
                            const MAX_WIDTH = 500; 
                            const scaleSize = MAX_WIDTH / img.width;
                            canvas.width = MAX_WIDTH;
                            canvas.height = img.height * scaleSize;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                            resolve(canvas.toDataURL('image/jpeg', 0.6));
                        };
                        img.onerror = (err) => reject(err);
                    };
                    reader.onerror = (err) => reject(err);
                });
            },

            loadFeed: function() {
                const grid = document.getElementById('productsGrid');
                grid.innerHTML = '';
                db.collection('products').orderBy('createdAt', 'desc').limit(20).get().then(snap => {
                    if (snap.empty) grid.innerHTML = '<div class="col-12 text-center mt-5 text-muted">Пока нет товаров. Добавь первый!</div>';
                    snap.forEach(doc => {
                        const d = doc.data();
                        const safeData = JSON.stringify(d).replace(/"/g, '&quot;');
                        grid.innerHTML += `<div class="col-6 col-md-4 col-lg-3"><div class="product-card h-100" onclick='app.showDetail("${doc.id}", ${safeData})'><img src="${d.imageUrl}" class="product-img"><div class="p-3"><h5 class="fw-bold mb-1">${d.price} ₽</h5><div class="text-truncate">${d.title}</div></div></div></div>`;
                    });
                });
            },

            showDetail: function(id, data) {
                this.hideViews();
                this.currentProduct = { id, ...data };
                document.getElementById('detailView').classList.remove('hidden');
                document.getElementById('detailImg').src = data.imageUrl;
                document.getElementById('detailTitle').innerText = data.title;
                document.getElementById('detailPrice').innerText = data.price + ' ₽';
                document.getElementById('detailDesc').innerText = data.description;
                document.getElementById('detailSeller').innerText = data.sellerName;
                if(this.currentUser) {
                    document.getElementById('chatSection').classList.remove('hidden');
                    document.getElementById('loginToChat').classList.add('hidden');
                    this.loadMessages(id);
                } else {
                    document.getElementById('chatSection').classList.add('hidden');
                    document.getElementById('loginToChat').classList.remove('hidden');
                }
            },

            loadMessages: function(pid) {
                if (this.unsubscribeChat) this.unsubscribeChat();
                const box = document.getElementById('chatBox'); box.innerHTML = '';
                this.unsubscribeChat = db.collection('products').doc(pid).collection('messages').orderBy('timestamp', 'asc').onSnapshot(s => {
                    s.docChanges().forEach(c => {
                        if (c.type === "added") {
                            const m = c.doc.data();
                            const isMe = m.uid === this.currentUser.uid;
                            box.innerHTML += `<div class="message ${isMe?'msg-me':'msg-other'}"><strong>${isMe?'Вы':m.name}:</strong> ${m.text}</div>`;
                            box.scrollTop = box.scrollHeight;
                        }
                    });
                });
            },

            sendMessage: function() {
                const txt = document.getElementById('msgInput').value.trim();
                if (!txt || !this.currentProduct) return;
                db.collection('products').doc(this.currentProduct.id).collection('messages').add({
                    text: txt, uid: this.currentUser.uid, name: this.currentUser.displayName, timestamp: firebase.firestore.FieldValue.serverTimestamp()
                });
                document.getElementById('msgInput').value = '';
            }
        };

        document.addEventListener('DOMContentLoaded', () => app.init());
    </script>
</body>
</html>

